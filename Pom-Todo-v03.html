<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POM-TODO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #dbf6fa;
        }
        ::-webkit-scrollbar-thumb {
            background: #273f43;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #00424a;
        }
        /* Custom styles for the circular progress bar */
        .progress-ring__circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        /* Task item animations */
        .task-item {
            transition: all 0.3s ease;
        }
        .task-item.completed {
            opacity: 0.5;
        }
        .task-item.completed .task-title {
            text-decoration: line-through;
        }
        /* Modal styles */
        .modal-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        /* Custom focus ring */
        *:focus-visible {
            outline: 2px solid #2f3b58;
            outline-offset: 2px;
        }
        .stopwatch-tick {
            stroke: #bac6ea; /* Corresponds to text-tertiary-light */
            transition: stroke 0.2s ease-in-out;
        }
        .stopwatch-tick.active {
            stroke: #00424a; /* Corresponds to text-primary-dark */
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#00424a',
                        'primary-light': '#edfcff',
                        'secondary-dark': '#273f43',
                        'secondary-light': '#dbf6fa',
                        'tertiary-dark': '#2f3b58',
                        'tertiary-light': '#bac6ea',
                        'background': '#cde7ec',
                        'error': '#de3730',
                        'neutral-dark': '#393c3d',
                        'neutral-light': '#f8fafa',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background text-neutral-dark antialiased">

    <div id="app" class="flex h-screen w-screen overflow-hidden">
        <!-- Left Sidebar -->
        <aside class="hidden md:flex flex-col items-center w-20 bg-secondary-dark text-neutral-light p-4 space-y-8">
            <div class="w-10 h-10 bg-tertiary-dark rounded-full flex items-center justify-center font-bold text-lg">
                A
            </div>
            <nav class="flex flex-col items-center space-y-6 mt-12 flex-grow">
                <button class="p-2 rounded-lg hover:bg-tertiary-dark transition-colors">
                    <i data-lucide="layout-dashboard"></i>
                </button>
                <button class="p-2 rounded-lg hover:bg-tertiary-dark transition-colors">
                    <i data-lucide="bar-chart-3"></i>
                </button>
                <button id="ai-assistant-btn" class="p-2 rounded-lg hover:bg-tertiary-dark transition-colors">
                    <i data-lucide="sparkles"></i>
                </button>
            </nav>
            <div class="flex flex-col items-center space-y-6">
                <button id="settings-btn" class="p-2 rounded-lg hover:bg-tertiary-dark transition-colors">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col bg-neutral-light overflow-hidden">
            <!-- Header -->
            <header class="flex items-center justify-between p-4 border-b border-secondary-light bg-neutral-light flex-shrink-0">
                <div class="flex items-center space-x-4">
                    <button class="md:hidden p-2 rounded-md hover:bg-secondary-light">
                        <i data-lucide="menu"></i>
                    </button>
                    <h1 class="font-bold text-lg text-secondary-dark" id="current-date">Saturday 18 OCT</h1>
                </div>
                <div class="flex items-center space-x-2">
                    
                    <div class="hidden sm:flex items-center space-x-1 text-secondary-dark">
                        <button class="p-2 rounded-md hover:bg-secondary-light"><i data-lucide="minus" class="w-4 h-4"></i></button>
                        <button class="p-2 rounded-md hover:bg-secondary-light"><i data-lucide="square" class="w-4 h-4"></i></button>
                        <button class="p-2 rounded-md hover:bg-error hover:text-white text-black"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
            </header>

            <!-- Task Area -->
            <div class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                
                <div class="bg-secondary-light p-6 rounded-xl mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex-1">
                        <div id="add-task" class=" bg-neutral-light p-6 rounded-xl mb-8 flex flex-col md:flex-row items-center w-full flex items-center justify-between gap-2">
                            <h2 class="text-2xl font-bold text-secondary-dark mb-4">Add a Task</h2>

                            <button id="add-task-btn" class="flex items-center space-x-2 bg-primary-dark text-neutral-light px-4 py-2 rounded-lg hover:bg-opacity-90 transition-colors">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                <span class="hidden sm:inline">Add Task</span>
                            </button>
                        </div>
                        <!-- Signal Tasks -->
                        <section class="mb-8">
                            <h2 class="text-2xl font-bold text-secondary-dark mb-4">Signal</h2>
                            <div id="signal-tasks" class="space-y-3">
                                <!-- Tasks will be injected here -->
                            </div>
                        </section>

                        <!-- Noise Tasks -->
                        <section>
                            <h2 class="text-2xl font-bold text-secondary-dark mb-4">Noise</h2>
                            <div id="noise-tasks" class="space-y-3">
                                <!-- Tasks will be injected here -->
                            </div>
                        </section>
                    </div>
                    <!-- Pomodoro Timer Display card -->
                    <div  id="pomodoro-display" >
                        <div class="bg-neutral-light rounded-xl p-6 w-80 h-[450px] mb-6 flex flex-col justify-between">
                            <div class="flex items-center justify-between ">
                                <h3 id="pomodoro-mode-btn" class="font-bold text-lg text-secondary-dark mb-4 cursor-pointer">Pomodoro</h3>
                                <h3 id="stopwatch-mode-btn" class="font-normal text-lg text-tertiary-dark mb-4 cursor-pointer">Stop Watch</h3>
                            </div>
                            <!-- Pomodoro UI -->
                            <div id="pomodoro-ui" class="h-full flex flex-col justify-between">
                                <div class="flex justify-center mb-4">
                                    <div class="relative w-60 h-50">
                                        <svg class="w-full h-full" viewBox="0 0 100 100">
                                            <circle class="text-tertiary-light" stroke-width="3" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                            <circle id="timer-progress-ring" class="progress-ring__circle text-primary-dark" stroke-width="6" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" />
                                        </svg>    
                                        <h4 id="timer-task-title" class="absolute inset-x-0 top-14 text-center text-xl text-secondary-dark"></h4>
                                        <span id="timer-display" class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-secondary-dark">25:00</span>
                                        <p id="timer-status" class="absolute inset-x-0 bottom-14 text-center text-l text-secondary-dark"></p>
                                    </div>
                                </div>
                                <div  class="flex items-center justify-center mb-4">
                                    <button id="timer-control-btn" class="bg-primary-dark text-white w-28 py-3 rounded-lg  font-semibold hover:bg-opacity-70 transition-all text-lg">START</button>
                                </div>    
                                <div class="w-full flex items-center justify-between gap-2">
                                    <p id="pomodoro-count-display" class="text-2xl font-bold text-primary-dark">0/4</p>
                                    <div class="flex items-center gap-2">
                                        <button id="timer-reset-btn" class="p-3 rounded-lg hover:bg-tertiary-light transition-colors"><i data-lucide="rotate-cw" class="w-6 h-6 text-secondary-dark"></i></button>
                                        <button id="skip-pomodoro-btn" class="p-3 rounded-lg hover:bg-tertiary-light transition-colors"><i data-lucide="skip-forward" class="w-6 h-6 text-secondary-dark"></i></button>
                                    </div>
                                </div>
                            </div>
                            <!-- Stopwatch UI (currently empty) -->
                            <div id="stopwatch-ui" class="hidden">
                                
                                <div class="h-full flex flex-col justify-between items-center py-6">

                                    <!-- 1. Title (matches pomodoro) -->
                                    <div>
                                        <h3 class="font-bold text-lg text-secondary-dark">Stopwatch</h3>
                                    </div>

                                    <!-- 2. The Ring and Time Display -->
                                    <div class="relative w-60 h-60">
                                        <!-- 
                                        SVG Container for the ticks. 
                                        The <g> (group) is rotated -90 degrees to start the ticks at the top.
                                        -->
                                        <svg class="w-full h-full" viewBox="0 0 100 100">
                                            <g id="stopwatch-tick-container" transform="rotate(-90 50 50)">
                                                <!-- Ticks will be dynamically generated here by the script below -->
                                            </g>
                                        </svg>

                                        <!-- Time display (unchanged ID) -->
                                        <span id="stopwatch-display"
                                            class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-secondary-dark">
                                            00:00
                                        </span>
                                    </div>

                                    <!-- 3. Control Button (Minimal, as in the image) -->
                                    <div class="flex items-center justify-center">
                                        <!-- 
                                        Single control button, styled to be circular.
                                        Your main JS will toggle the text between START and PAUSE.
                                        -->
                                        <button id="stopwatch-control-btn"
                                            class="bg-transparent border-2 border-primary-dark text-primary-dark w-32 py-3 rounded-full font-semibold hover:bg-primary-dark hover:text-white transition-all text-lg">
                                            START
                                        </button>
                                    </div>
                                </div>

<!-- 
  This script generates the 60 tick marks for the stopwatch.
  Your main application script (in POM-TODO.html) will be responsible for
  finding these ticks and changing their class/color based on the timer.
-->
<script>
</script>


                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-full lg:w-80 xl:w-96 bg-secondary-light p-6 overflow-y-auto flex-shrink-0 border-l border-background">
            <!-- Performance Card -->
            <div class="bg-neutral-light rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-secondary-dark mb-4">Performance</h3>
                <div class="flex justify-center mb-4">
                    <div class="relative w-32 h-32">
                        <svg class="w-full h-full" viewBox="0 0 100 100">
                            <circle class="text-tertiary-light" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                            <circle class="progress-ring__circle text-primary-dark" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" stroke-linecap="round" style="stroke-dasharray: 283; stroke-dashoffset: 42.45;" />
                        </svg>
                        <span class="absolute inset-0 flex items-center justify-center text-5xl font-bold text-primary-dark">A</span>
                    </div>
                </div>
                <div class="flex items-center justify-between ">
                    <div>
                        <p class="text-sm text-tertiary-dark">Hours</p>
                        <p class="text-2xl font-bold text-primary-dark">6.5</p>
                    </div>
                    <div>
                        <p class="text-sm text-tertiary-dark">Productivity</p>
                        <p class="text-2xl font-bold text-primary-dark">85%</p>
                    </div>
                </div>
            </div>

            <!-- Weekly Calendar -->
            <div>
                <h3 class="font-bold text-lg text-secondary-dark mb-4">Weekly Progress</h3>
                <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-tertiary-dark">
                    <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                </div>
                <div class="grid grid-cols-7 gap-2 mt-2">
                    
                    <!-- Calendar squares will be injected here -->
                </div>
            </div>
            
            <!-- Google Drive Sync -->
            <div class="mt-8">
                 <button id="gdrive-sync-btn" class="w-full flex items-center justify-center gap-2 bg-neutral-light border border-tertiary-light text-tertiary-dark py-3 rounded-lg hover:bg-tertiary-light transition-colors">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span>Sync to Google Drive</span>
                </button>
            </div>
        </aside>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-neutral-light rounded-xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto modal-content scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-2xl font-bold text-secondary-dark">Add New Task</h2>
                <button id="close-modal-btn" class="p-1 rounded-full hover:bg-secondary-light"><i data-lucide="x" class="text-secondary-dark"></i></button>
            </div>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-tertiary-dark mb-1">Title</label>
                    <input type="text" id="task-title-input" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark" required>
                </div>
                <div class="mb-4">
                    <label for="task-category" class="block text-sm font-medium text-tertiary-dark mb-1">Category</label>
                    <select id="task-category" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                        <option value="signal">Signal</option>
                        <option value="noise">Noise</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="task-pomodoros" class="block text-sm font-medium text-tertiary-dark mb-1">Estimated Pomodoros</label>
                    <input type="number" id="task-pomodoros" min="1" value="1" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                </div>
                <div class="mb-6">
                    <label for="task-recurrence" class="block text-sm font-medium text-tertiary-dark mb-1">Recurrence</slabel>
                    <select id="task-recurrence" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                        <option value="none">None</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                    </select>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-primary-dark text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    

    <!-- AI Assistant Modal -->
    <div id="ai-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-neutral-light rounded-xl p-8 w-full max-w-md modal-content scale-95">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2"><i data-lucide="sparkles" class="text-primary-dark"></i>AI Assistant</h2>
                <button id="close-ai-modal-btn" class="p-1 rounded-full hover:bg-secondary-light"><i data-lucide="x" class="text-secondary-dark"></i></button>
            </div>
            <div id="ai-response" class="bg-secondary-light p-4 rounded-lg min-h-[100px] mb-4 text-tertiary-dark">
                <p>Hello! I'm here to help you stay productive. Ask me for advice based on your activity.</p>
            </div>
            <button id="get-ai-advice-btn" class="w-full bg-tertiary-dark text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">Get Advice</button>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden modal-backdrop">
        <div class="bg-neutral-light rounded-xl p-8 w-full max-w-md max-h-[90vh] overflow-y-auto modal-content scale-95">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-secondary-dark flex items-center gap-2"><i data-lucide="settings" class="text-primary-dark"></i>Settings</h2>
                <button id="close-settings-modal-btn" class="p-1 rounded-full hover:bg-secondary-light"><i data-lucide="x" class="text-secondary-dark"></i></button>
            </div>
            <div class="flex justify-around mb-6 border-b border-secondary-light pb-4">
                <button id="pomodoro-settings-btn" class="p-2 rounded-lg hover:bg-secondary-light" aria-label="Timer Settings"><i data-lucide="clock" class="text-secondary-dark"></i></button>
                <button id="general-settings-btn" class="p-2 rounded-lg bg-secondary-light" aria-label="General Settings"><i data-lucide="settings" class="text-secondary-dark"></i></button>
                <button id="theme-settings-btn" class="p-2 rounded-lg hover:bg-secondary-light" aria-label="Theme Settings"><i data-lucide="palette" class="text-secondary-dark"></i></button>
                <button id="info-settings-btn" class="p-2 rounded-lg hover:bg-secondary-light" aria-label="About & Help"><i data-lucide="help-circle" class="text-secondary-dark"></i></button>
            </div>

            <!-- Settings Content Area -->
            <div id="settings-content">
                <!-- Timer Settings (was settings-form) -->
                <div id="pomodoro-settings-panel" class="settings-panel hidden">
                    <form id="settings-form">
                        <div class="space-y-4">
                            <h3 class="text-lg font-semibold text-secondary-dark border-b border-secondary-light pb-2">Timer Durations (minutes)</h3>
                            <div>
                                <div class="mb-4">
                                    <label for="setting-pomodoro" class="block text-sm font-medium text-tertiary-dark mb-1">Pomodoro</label>
                                    <input type="number" id="setting-pomodoro" min="1" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                                </div>
                                <div class="mb-4">
                                    <label for="setting-short-break" class="block text-sm font-medium text-tertiary-dark mb-1">Short Break</label>
                                    <input type="number" id="setting-short-break" min="1" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                                </div>
                                <div class="mb-4">
                                    <label for="setting-long-break" class="block text-sm font-medium text-tertiary-dark mb-1">Long Break</label>
                                    <input type="number" id="setting-long-break" min="1" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                                </div>
                                <div class="mb-4">
                                    <label for="setting-pomodoro-rounds" class="block text-sm font-medium text-tertiary-dark mb-1">Rounds</label>
                                    <input type="number" id="setting-pomodoro-rounds" min="1" value="4" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                                </div>
                            </div>
                        </div>
                        <div class="flex justify-end mt-8">
                            <button type="submit" class="bg-primary-dark text-white px-6 py-2 rounded-lg font-semibold hover:bg-opacity-90 transition-colors">Save Settings</button>
                        </div>
                    </form>
                </div>
                <div id="general-settings-panel" class="settings-panel hidden">
                    <div class="mb-4">
                        <label for="setting-pomodoro-rounds" class="block text-sm font-medium text-tertiary-dark mb-1">Rounds</label>
                        <input type="select" id="setting-pomodoro-sound" min="1" value="4" class="w-full p-2 border border-tertiary-light rounded-md bg-white focus:ring-2 focus:ring-tertiary-dark">
                    </div>
                </div>
                <div id="theme-settings-panel" class="settings-panel hidden"></div>
                <div id="info-settings-panel" class="settings-panel hidden">
                    <p> hellow </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-secondary-dark text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 opacity-0 transition-all duration-300">
        <p id="toast-message">Synced to Google Drive!</p>
    </div>

    <audio id="tick-sound" src="https://www.soundjay.com/clock/sounds/clock-ticking-1.mp3" loop></audio>
    <audio id="alarm-sound" src="https://www.soundjay.com/misc/sounds/bell-ringing-05.mp3"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();

    // --- App State and Constants ---
    const POMODORO_TIME = 25 * 60;
    const SHORT_BREAK_TIME = 5 * 60;
    const LONG_BREAK_TIME = 15 * 60;
    const MAX_TITLE_LENGTH_IN_RING = 14;

    let state = {
        tasks: [],
        timer: {
            displayMode: 'pomodoro', // 'pomodoro', 'stopwatch'
            mode: 'pomodoro', // 'pomodoro', 'shortBreak', 'longBreak'
            timeLeft: POMODORO_TIME,
            isActive: false,
            intervalId: null,
            currentTaskId: null,
        },
        // NEW: State for the stopwatch
        stopwatch: {
            startTime: 0,
            elapsedTime: 0,
            isActive: false,
            intervalId: null,
            lastSecond: -1 // Used to check when to update the display
        },
        settings: {
            pomodoroTime: 25,
            shortBreakTime: 5,
            longBreakTime: 15,
            autoStartBreaks: false,
            autoStartPomodoros: false,
        },
        stats: {
            pomodorosCompleted: 0,
            hoursFocused: 0,
        },
    };

    // --- DOM Element Selectors ---
    const signalTasksContainer = document.getElementById('signal-tasks');
    const noiseTasksContainer = document.getElementById('noise-tasks');
    const addTaskBtn = document.getElementById('add-task-btn');
    const taskModal = document.getElementById('task-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const taskForm = document.getElementById('task-form');
    const modalTitle = document.getElementById('modal-title');
    const pomodoroModeBtn = document.getElementById('pomodoro-mode-btn');
    const stopwatchModeBtn = document.getElementById('stopwatch-mode-btn');
    const pomodoroUi = document.getElementById('pomodoro-ui');
    const stopwatchUi = document.getElementById('stopwatch-ui');

    // Pomodoro Elements
    const timerDisplay = document.getElementById('timer-display');
    const timerProgressRing = document.getElementById('timer-progress-ring');
    const timerControlBtn = document.getElementById('timer-control-btn');
    const timerResetBtn = document.getElementById('timer-reset-btn');
    const skipPomodoroBtn = document.getElementById('skip-pomodoro-btn');
    const timerTaskTitle = document.getElementById('timer-task-title');
    const pomodoroCountDisplay = document.getElementById('pomodoro-count-display');
    const timerStatus = document.getElementById('timer-status');

    // NEW: Stopwatch Elements
    const stopwatchDisplay = document.getElementById('stopwatch-display');
    const stopwatchControlBtn = document.getElementById('stopwatch-control-btn');
    const stopwatchTickContainer = document.getElementById('stopwatch-tick-container');

    // Audio & Other Elements
    const tickSound = document.getElementById('tick-sound');
    const alarmSound = document.getElementById('alarm-sound');
    const gdriveSyncBtn = document.getElementById('gdrive-sync-btn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');
    const aiModal = document.getElementById('ai-modal');
    const aiAssistantBtn = document.getElementById('ai-assistant-btn');
    const closeAiModalBtn = document.getElementById('close-ai-modal-btn');
    const getAiAdviceBtn = document.getElementById('get-ai-advice-btn');
    const aiResponse = document.getElementById('ai-response');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsModalBtn = document.getElementById('close-settings-modal-btn');
    const settingsForm = document.getElementById('settings-form');
    const pomodoroSettingsBtn = document.getElementById('pomodoro-settings-btn');
    const generalSettingsBtn = document.getElementById('general-settings-btn');
    const themeSettingsBtn = document.getElementById('theme-settings-btn');
    const infoSettingsBtn = document.getElementById('info-settings-btn');




    // Pomodoro Ring Setup
    const radius = timerProgressRing.r.baseVal.value;
    const circumference = radius * 2 * Math.PI;
    timerProgressRing.style.strokeDasharray = `${circumference} ${circumference}`;
    timerProgressRing.style.strokeDashoffset = circumference;

    // --- NEW: Stopwatch Tick Generation ---
    // Moved from stopwatch_ui.html to here, ensuring it runs after DOM is loaded
    (function generateStopwatchTicks() {
        if (!stopwatchTickContainer) return;

        stopwatchTickContainer.innerHTML = ''; // Clear any existing ticks
        const numTicks = 60;
        const center = 50;
        const radiusInner = 42;
        const radiusOuter = 48;

        for (let i = 0; i < numTicks; i++) {
            const angle = (i / numTicks) * 2 * Math.PI;
            const x1 = center + Math.cos(angle) * radiusInner;
            const y1 = center + Math.sin(angle) * radiusInner;
            const x2 = center + Math.cos(angle) * radiusOuter;
            const y2 = center + Math.sin(angle) * radiusOuter;

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('id', `stopwatch-tick-${i}`);
            line.setAttribute('class', 'stopwatch-tick');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke-width', '2.5');
            stopwatchTickContainer.appendChild(line);
        }
    })();


    // --- Utility Functions ---
    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60); // Use floor to handle potential floats
        return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    };

    const updateDisplayModeUI = () => {
        if (state.timer.displayMode === 'pomodoro') {
            pomodoroModeBtn.classList.add('font-bold', 'text-secondary-dark');
            pomodoroModeBtn.classList.remove('font-normal', 'text-tertiary-dark');
            stopwatchModeBtn.classList.add('font-normal', 'text-tertiary-dark');
            stopwatchModeBtn.classList.remove('font-bold', 'text-secondary-dark');
            pomodoroUi.classList.remove('hidden');
            stopwatchUi.classList.add('hidden');
            // NEW: Pause and reset stopwatch when switching away
            pauseStopwatch();
            resetStopwatch();
        } else { // stopwatch
            stopwatchModeBtn.classList.add('font-bold', 'text-secondary-dark');
            stopwatchModeBtn.classList.remove('font-normal', 'text-tertiary-dark');
            pomodoroModeBtn.classList.add('font-normal', 'text-tertiary-dark');
            pomodoroModeBtn.classList.remove('font-bold', 'text-secondary-dark');
            stopwatchUi.classList.remove('hidden');
            pomodoroUi.classList.add('hidden');
            // Pause pomodoro when switching to stopwatch
            pauseTimer();
        }
    };

    const truncateText = (text, maxLength) => {
        if (!text || text.length <= maxLength) {
            return text;
        }
        return text.slice(0, maxLength).trim() + '...';
    };

    const showToast = (message) => {
        toastMessage.textContent = message;
        toast.classList.remove('translate-y-20', 'opacity-0');
        setTimeout(() => {
            toast.classList.add('translate-y-20', 'opacity-0');
        }, 3000);
    };

    // --- Data Persistence (Simulated) ---
    const saveState = () => {
        localStorage.setItem('pomTodoState', JSON.stringify(state));
    };

    const loadState = () => {
        const savedState = localStorage.getItem('pomTodoState');
        if (savedState) {
            // Merge saved state, but ensure timer/stopwatch are reset
            const loaded = JSON.parse(savedState);
            state.tasks = loaded.tasks || [];
            state.settings = loaded.settings || state.settings;
            state.stats = loaded.stats || state.stats;
            
            // Reset timers on load
            state.timer.isActive = false;
            state.timer.intervalId = null;
            state.timer.timeLeft = state.settings.pomodoroTime * 60;
            state.stopwatch = { startTime: 0, elapsedTime: 0, isActive: false, intervalId: null, lastSecond: -1 };

        } else {
            // Add default tasks if no state is saved
            state.tasks = [
                { id: 1, title: 'CS50 for 3 hrs', category: 'signal', pomodoros: 6, completedPomodoros: 1, recurrence: 'daily', completed: false },
                { id: 2, title: 'Review project brief', category: 'signal', pomodoros: 1, completedPomodoros: 0, recurrence: 'none', completed: false },
                { id: 3, title: 'Check emails', category: 'noise', pomodoros: 1, completedPomodoros: 0, recurrence: 'daily', completed: true },
            ];
        }
    };

    // --- TaskList Component Logic ---
    const renderTasks = () => {
        signalTasksContainer.innerHTML = '';
        noiseTasksContainer.innerHTML = '';
        pomodoroCountDisplay.textContent = `${state.stats.pomodorosCompleted % 4}/4`;

        if (state.tasks.length === 0) {
            signalTasksContainer.innerHTML = `<p class="text-tertiary-dark">No tasks yet. Add one to get started!</p>`;
        }

        state.tasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = `task-item bg-white p-4 rounded-lg flex items-center justify-between shadow-sm hover:shadow-md ${task.completed ? 'completed' : ''}`;
            taskItem.dataset.id = task.id;

            taskItem.innerHTML = `
                <div class="flex items-center gap-4">
                    <button class="task-complete-btn flex-shrink-0 w-6 h-6 rounded-full border-2 ${task.completed ? 'bg-primary-dark border-primary-dark' : 'border-tertiary-light'} flex items-center justify-center">
                        ${task.completed ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : ''}
                    </button>
                    <div>
                        <p class="task-title font-medium text-secondary-dark">${task.title}</p>
                        <p class="text-sm text-tertiary-dark">${task.completedPomodoros}/${task.pomodoros} Pomodoros</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button class="task-reset-btn p-2 rounded-md hover:bg-secondary-light"><i data-lucide="rotate-cw" class="w-5 h-5 text-tertiary-dark"></i></button>
                    ${state.timer.currentTaskId === task.id && state.timer.isActive && state.timer.displayMode === 'pomodoro' ? 
                        `<div class="w-6 h-6 rounded-full bg-primary-dark flex items-center justify-center animate-pulse"><div class="w-2 h-2 bg-white rounded-full"></div></div>` :
                        `<button class="task-start-btn p-2 rounded-md hover:bg-secondary-light ${task.completed ? 'hidden' : ''}"><i data-lucide="play-circle" class="w-5 h-5 text-primary-dark"></i></button>`
                    }
                    <button class="task-edit-btn p-2 rounded-md hover:bg-secondary-light"><i data-lucide="edit-2" class="w-5 h-5 text-tertiary-dark"></i></button>
                    <button class="task-delete-btn p-2 rounded-md hover:bg-secondary-light"><i data-lucide="trash-2" class="w-5 h-5 text-error"></i></button>
                </div>
            `;

            if (task.category === 'signal') {
                signalTasksContainer.appendChild(taskItem);
            } else {
                noiseTasksContainer.appendChild(taskItem);
            }
        });
        lucide.createIcons();
    };

    // --- TaskForm Component Logic ---
    const openTaskModal = (task = null) => {
        taskForm.reset();
        if (task) {
            modalTitle.textContent = 'Edit Task';
            document.getElementById('task-id').value = task.id;
            document.getElementById('task-title-input').value = task.title;
            document.getElementById('task-category').value = task.category;
            document.getElementById('task-pomodoros').value = task.pomodoros;
            document.getElementById('task-recurrence').value = task.recurrence;
        } else {
            modalTitle.textContent = 'Add New Task';
            document.getElementById('task-id').value = '';
        }
        taskModal.classList.remove('hidden');
        setTimeout(() => {
            taskModal.querySelector('.modal-content').classList.remove('scale-95');
            taskModal.classList.remove('opacity-0');
        }, 10);
    };

    const closeTaskModal = () => {
        taskModal.querySelector('.modal-content').classList.add('scale-95');
        taskModal.classList.add('opacity-0');
        setTimeout(() => taskModal.classList.add('hidden'), 300);
    };

    const handleTaskFormSubmit = (e) => {
        e.preventDefault();
        const id = document.getElementById('task-id').value;
        const taskData = {
            title: document.getElementById('task-title-input').value,
            category: document.getElementById('task-category').value,
            pomodoros: parseInt(document.getElementById('task-pomodoros').value),
            recurrence: document.getElementById('task-recurrence').value,
        };

        if (id) {
            const taskIndex = state.tasks.findIndex(t => t.id == id);
            state.tasks[taskIndex] = { ...state.tasks[taskIndex], ...taskData };
        } else {
            const newTask = {
                id: Date.now(),
                completedPomodoros: 0,
                completed: false,
                ...taskData
            };
            state.tasks.push(newTask);
        }
        saveState();
        renderApp();
        closeTaskModal();
    };

    // --- Settings Modal Logic ---
    const updateSettingsView = (activePanelId) => {
        // Hide all panels
        document.querySelectorAll('.settings-panel').forEach(panel => {
            panel.classList.add('hidden');
        });

        // Show the active one
        const activePanel = document.getElementById(activePanelId);
        if (activePanel) {
            activePanel.classList.remove('hidden');
        }

        // Update button styles
        const navButtons = {
            'pomodoro-settings-panel': pomodoroSettingsBtn,
            'general-settings-panel': generalSettingsBtn,
            'theme-settings-panel': themeSettingsBtn,
            'info-settings-panel': infoSettingsBtn,
        };

        Object.values(navButtons).forEach(btn => btn.classList.remove('bg-secondary-light'));
        if (navButtons[activePanelId]) {
            navButtons[activePanelId].classList.add('bg-secondary-light');
        }
    };
    // --- Settings Modal Logic ---
    const openSettingsModal = () => {
        // Populate form with current settings from state
        document.getElementById('setting-pomodoro').value = state.settings.pomodoroTime;
        document.getElementById('setting-short-break').value = state.settings.shortBreakTime;
        document.getElementById('setting-long-break').value = state.settings.longBreakTime;

        settingsModal.classList.remove('hidden');
        setTimeout(() => {
            settingsModal.querySelector('.modal-content').classList.remove('scale-95');
            settingsModal.classList.remove('opacity-0');
        }, 10);

        // Set the default view
        updateSettingsView('pomodoro-settings-panel');
    };

    const closeSettingsModal = () => {
        settingsModal.querySelector('.modal-content').classList.add('scale-95');
        settingsModal.classList.add('opacity-0');
        setTimeout(() => settingsModal.classList.add('hidden'), 300);
    };

    const handleSettingsFormSubmit = (e) => {
        e.preventDefault();
        state.settings.pomodoroTime = parseInt(document.getElementById('setting-pomodoro').value);
        state.settings.shortBreakTime = parseInt(document.getElementById('setting-short-break').value);
        state.settings.longBreakTime = parseInt(document.getElementById('setting-long-break').value);

        saveState();
        closeSettingsModal();
        showToast('Settings saved!');

        // Reset the current timer to apply new settings if it's not active
        if (!state.timer.isActive) {
            resetTimer(state.timer.mode, state.timer.currentTaskId);
        }
    };

    // --- Pomodoro Timer Logic ---
    const updateTimerDisplay = () => {
        timerDisplay.textContent = formatTime(state.timer.timeLeft);
        const totalDuration = state.timer.mode === 'pomodoro' ? state.settings.pomodoroTime * 60 : (state.timer.mode === 'shortBreak' ? state.settings.shortBreakTime * 60 : state.settings.longBreakTime * 60);
        const progress = (totalDuration - state.timer.timeLeft) / totalDuration;
        const offset = circumference - progress * circumference;
        timerProgressRing.style.strokeDashoffset = offset;
    };

    const startTimer = () => {
        if (state.timer.isActive) return;
        state.timer.isActive = true;
        timerControlBtn.textContent = 'PAUSE';
        tickSound.play();

        state.timer.intervalId = setInterval(() => {
            state.timer.timeLeft--;
            updateTimerDisplay();
            if (state.timer.timeLeft <= 0) {
                clearInterval(state.timer.intervalId);
                handleTimerEnd();
            }
        }, 1000);
        renderTasks();
    };

    const pauseTimer = () => {
        if (!state.timer.isActive) return;
        state.timer.isActive = false;
        clearInterval(state.timer.intervalId);
        timerControlBtn.textContent = 'START';
        tickSound.pause();
        renderTasks();
    };

    const resetTimer = (mode = 'pomodoro', taskId = null) => {
        pauseTimer();
        state.timer.mode = mode;
        state.timer.currentTaskId = taskId;
        
        const currentTask = state.tasks.find(t => t.id === taskId);
        timerTaskTitle.textContent = currentTask ? truncateText(currentTask.title, MAX_TITLE_LENGTH_IN_RING) : '';

        switch (mode) {
            case 'pomodoro':
                state.timer.timeLeft = state.settings.pomodoroTime * 60;
                timerStatus.textContent = 'Time to focus!';
                break;
            case 'shortBreak':
                state.timer.timeLeft = state.settings.shortBreakTime * 60;
                timerStatus.textContent = 'Time for a short break!';
                break;
            case 'longBreak':
                state.timer.timeLeft = state.settings.longBreakTime * 60;
                timerStatus.textContent = 'Time for a long break!';
                break;
        }
        updateTimerDisplay();
    };

    const handleTimerEnd = () => {
        state.timer.isActive = false;
        tickSound.pause();
        alarmSound.play();
        
        if (Notification.permission === "granted") {
            new Notification("POM-TODO", { body: `${timerStatus.textContent} is over!` });
        }

        if (state.timer.mode === 'pomodoro') {
            if (state.timer.currentTaskId) {
                const task = state.tasks.find(t => t.id === state.timer.currentTaskId);
                if (task) {
                    task.completedPomodoros++;
                    if (task.completedPomodoros >= task.pomodoros) {
                        task.completed = true;
                    }
                }
            }
            state.stats.pomodorosCompleted++; // Increment here
            const nextMode = state.stats.pomodorosCompleted % 4 === 0 ? 'longBreak' : 'shortBreak';
            resetTimer(nextMode);
        } else {
            // Break ended, start next pomodoro
            resetTimer('pomodoro', state.timer.currentTaskId);
        }
        saveState();
        renderApp();
    };

    const handleTimerControlClick = () => {
        if (state.timer.isActive) {
            pauseTimer();
        } else {
            startTimer();
        }
    };

    const skipPomodoro = () => {
        pauseTimer();
        alarmSound.play();
        if (state.timer.mode === 'pomodoro') {
            state.stats.pomodorosCompleted++; // Count skipped pomodoro
            if (state.timer.currentTaskId) {
                const task = state.tasks.find(t => t.id === state.timer.currentTaskId);
                if (task) {
                    task.completedPomodoros++;
                    if (task.completedPomodoros >= task.pomodoros) {
                        task.completed = true;
                    }
                }
            }
            const nextMode = state.stats.pomodorosCompleted % 4 === 0 ? 'longBreak' : 'shortBreak';
            resetTimer(nextMode, state.timer.currentTaskId);
        } else {
            // Skipping a break, go back to a pomodoro session
            resetTimer('pomodoro', state.timer.currentTaskId);
        }
        saveState(); // Save state after skipping
        renderApp();
        startTimer(); // Automatically start the next session
    };

    // --- NEW: Stopwatch Logic ---
    const updateStopwatchDisplay = (totalSeconds) => {
        // Update 00:00 display
        stopwatchDisplay.textContent = formatTime(totalSeconds);

        // Update 60-tick ring
        const currentSecondOnRing = totalSeconds % 60;
        const allTicks = stopwatchTickContainer.querySelectorAll('.stopwatch-tick');

        allTicks.forEach((tick, index) => {
            if (index < currentSecondOnRing) {
                tick.classList.add('active');
            } else {
                tick.classList.remove('active');
            }
        });
        // Handle the 60th second (which is 0 on the ring)
        if (totalSeconds > 0 && currentSecondOnRing === 0) {
             allTicks.forEach(tick => tick.classList.add('active'));
        }
         // Handle 0 seconds (reset)
        if (totalSeconds === 0) {
            allTicks.forEach(tick => tick.classList.remove('active'));
        }
    };

    const startStopwatch = () => {
        if (state.stopwatch.isActive) return;
        state.stopwatch.isActive = true;
        stopwatchControlBtn.textContent = 'PAUSE';

        // Start time is now, minus any time that has already elapsed
        state.stopwatch.startTime = Date.now() - state.stopwatch.elapsedTime;
        
        state.stopwatch.intervalId = setInterval(() => {
            const elapsedMilliseconds = Date.now() - state.stopwatch.startTime;
            state.stopwatch.elapsedTime = elapsedMilliseconds;
            
            const totalSeconds = Math.floor(elapsedMilliseconds / 1000);
            
            // Only update the display if the second has changed
            if (totalSeconds !== state.stopwatch.lastSecond) {
                updateStopwatchDisplay(totalSeconds);
                state.stopwatch.lastSecond = totalSeconds;
            }
        }, 100); // Check 10 times per second for responsive start/stop
    };

    const pauseStopwatch = () => {
        if (!state.stopwatch.isActive) return;
        state.stopwatch.isActive = false;
        clearInterval(state.stopwatch.intervalId);
        stopwatchControlBtn.textContent = 'START';
    };

    const resetStopwatch = () => {
        pauseStopwatch();
        state.stopwatch.elapsedTime = 0;
        state.stopwatch.startTime = 0;
        state.stopwatch.lastSecond = -1;
        updateStopwatchDisplay(0); // Reset display to 00:00 and clear ticks
    };

    // --- Event Handlers ---
    addTaskBtn.addEventListener('click', () => openTaskModal());
    closeModalBtn.addEventListener('click', closeTaskModal);
    taskModal.addEventListener('click', (e) => {
        if (e.target === taskModal) closeTaskModal();
    });
    taskForm.addEventListener('submit', handleTaskFormSubmit);

    // Timer Mode Switching
    pomodoroModeBtn.addEventListener('click', () => {
        state.timer.displayMode = 'pomodoro';
        updateDisplayModeUI();
    });
    stopwatchModeBtn.addEventListener('click', () => {
        state.timer.displayMode = 'stopwatch';
        updateDisplayModeUI();
    });

    // Task Actions
    const handleTaskActions = (e) => {
        const taskItem = e.target.closest('.task-item');
        if (!taskItem) return;
        const taskId = parseInt(taskItem.dataset.id);

        if (e.target.closest('.task-complete-btn')) {
            const task = state.tasks.find(t => t.id === taskId);
            task.completed = !task.completed;
        }
        if (e.target.closest('.task-reset-btn')) {
            const task = state.tasks.find(t => t.id === taskId);
            if (task) {
                task.completedPomodoros = 0;
                task.completed = false;
            }
        }
        if (e.target.closest('.task-edit-btn')) {
            const task = state.tasks.find(t => t.id === taskId);
            openTaskModal(task);
        }
        if (e.target.closest('.task-delete-btn')) {
            state.tasks = state.tasks.filter(t => t.id !== taskId);
            if (state.timer.currentTaskId === taskId) {
                resetTimer('pomodoro'); // Reset timer if active task is deleted
            }
        }
        if (e.target.closest('.task-start-btn')) {
            resetTimer('pomodoro', taskId);
            startTimer();
        }
        saveState();
        renderApp();
    };

    signalTasksContainer.addEventListener('click', handleTaskActions);
    noiseTasksContainer.addEventListener('click', handleTaskActions);

    // Pomodoro Controls
    timerControlBtn.addEventListener('click', handleTimerControlClick);
    timerResetBtn.addEventListener('click', () => resetTimer(state.timer.mode, state.timer.currentTaskId));
    skipPomodoroBtn.addEventListener('click', skipPomodoro);

    // NEW: Stopwatch Controls
    stopwatchControlBtn.addEventListener('click', () => {
        if (state.stopwatch.isActive) {
            pauseStopwatch();
        } else {
            startStopwatch();
        }
    });

    // Other UI Controls
    gdriveSyncBtn.addEventListener('click', () => {
        saveState();
        showToast('Synced to Google Drive!');
    });
    
    // AI Modal Logic
    const aiAdvices = [
        "You've been working hard! Remember to stretch and hydrate.",
        "Try breaking down your biggest 'Signal' task into smaller sub-tasks.",
        "Great focus! Consider taking a 5-minute walk to refresh your mind.",
        "Your productivity is high. Keep up the momentum!",
        "Feeling stuck? Switch to a 'Noise' task for a quick win."
    ];
    aiAssistantBtn.addEventListener('click', () => aiModal.classList.remove('hidden'));
    closeAiModalBtn.addEventListener('click', () => aiModal.classList.add('hidden'));
    getAiAdviceBtn.addEventListener('click', () => {
        const randomIndex = Math.floor(Math.random() * aiAdvices.length);
        aiResponse.innerHTML = `<p>${aiAdvices[randomIndex]}</p>`;
    });

    // Settings Modal
    settingsBtn.addEventListener('click', openSettingsModal);
    closeSettingsModalBtn.addEventListener('click', closeSettingsModal);
    settingsForm.addEventListener('submit', handleSettingsFormSubmit);
    settingsModal.addEventListener('click', (e) => {
        if (e.target === settingsModal) closeSettingsModal();
    });
    pomodoroSettingsBtn.addEventListener('click', () => updateSettingsView('pomodoro-settings-panel'));
    generalSettingsBtn.addEventListener('click', () => {
        // For now, general settings is empty. We can add content later.
        updateSettingsView('general-settings-panel');
        document.getElementById('general-settings-panel').innerHTML = '<p class="text-tertiary-dark">General settings will be available here.</p>';
    });

    // --- App Initialization ---
    const renderApp = () => {
        renderTasks();
        updateTimerDisplay(); // Renders pomodoro timer
        updateStopwatchDisplay(Math.floor(state.stopwatch.elapsedTime / 1000)); // Renders stopwatch
        updateDisplayModeUI(); // Manages visibility
    };

    const init = () => {
        // Set current date 
        const today = new Date();
        const options = { weekday: 'long', day: 'numeric', month: 'short' };
        document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', options).toUpperCase();

        // Request notification permission
        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }

        loadState();
        resetTimer('pomodoro');
        resetStopwatch();
        renderApp();
    };

    init();
});

    </script>
</body>
</html>
